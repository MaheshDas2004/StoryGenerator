{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
.bg-button {
  background: linear-gradient(135deg, #FF6B35 0%, #EC4899 50%, #8B5CF6 100%);
}
.text-gradient {
  background: linear-gradient(135deg, #FF6B35 0%, #EC4899 50%, #8B5CF6 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.story-text {
  line-height: 1.8;
  font-family: 'Georgia', serif;
}
.age-radio-label {
  transition: all 0.3s ease;
}
.age-radio-label:hover {
  transform: scale(1.05);
}
.age-radio-label.selected {
  background: linear-gradient(135deg, #14b8a6, #0891b2) !important;
  border-color: #0891b2 !important;
  transform: scale(1.1);
  box-shadow: 0 0 20px rgba(8, 145, 178, 0.4);
  color: white !important;
}
.compact-form {
  backdrop-filter: blur(10px);
  background: rgba(17, 24, 39, 0.8);
}
.form-section {
  background: rgba(55, 65, 81, 0.3);
  border: 1px solid rgba(75, 85, 99, 0.5);
  backdrop-filter: blur(5px);
}
.form-input {
  background: rgba(55, 65, 81, 0.8);
  border: 1px solid rgba(75, 85, 99, 0.6);
  backdrop-filter: blur(5px);
}
.form-input:focus {
  background: rgba(55, 65, 81, 0.9);
  border-color: #8B5CF6;
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}
</style>

<!-- Main Container -->
<div class="relative w-full min-h-screen overflow-hidden">
    <!-- Background Effects -->
    <div class="absolute inset-0">
        <div class="absolute top-20 left-10 w-32 h-32 bg-orange-500/20 rounded-full blur-xl animate-pulse"></div>
        <div class="absolute top-40 right-20 w-24 h-24 bg-teal-500/30 rounded-full blur-lg animate-bounce"></div>
        <div class="absolute bottom-32 left-1/4 w-40 h-40 bg-purple-500/15 rounded-full blur-2xl animate-ping"></div>
        <div class="absolute bottom-20 right-1/3 w-28 h-28 bg-pink-500/20 rounded-full blur-xl animate-pulse"></div>
        
        <div class="absolute inset-0 opacity-5">
            <div class="w-full h-full" style="background-image: radial-gradient(circle, #ffffff 1px, transparent 1px); background-size: 50px 50px;"></div>
        </div>
    </div>

    <!-- Content Container -->
    <div class="relative z-10 container mx-auto px-6 py-12">
        
        <!-- Step 1: Genre, Theme, Characters Selection -->
        {% if setstep1 %}
        <form action="{% url "create_story" %}" method="POST">
            <div id="step1" class="step-content">
                <div class="text-center mb-12">
                    <div class="inline-flex items-center px-6 py-3 rounded-full bg-orange-500/10 border border-orange-500/20 mb-6">
                        <span class="text-orange-400 text-sm font-bold tracking-widest">‚ú® STEP 1 OF 2</span>
                    </div>
                    <h1 class="text-5xl lg:text-7xl font-black mb-4 leading-none">
                        <span class="text-white">Choose Your</span><br>
                        <span class="text-gradient">Story Elements</span>
                    </h1>
                    <p class="text-xl text-gray-300 max-w-2xl mx-auto">
                        Select the perfect combination of genre, theme, and characters for your personalized bedtime story
                    </p>
                </div>

                {% csrf_token %}
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                    
                    <!-- Genres Column -->
                    <input type="hidden" name="step1" value="step1"/>
                    <div class="bg-gray-800/30 rounded-3xl p-8 border border-gray-700 hover:border-orange-500/30 transition-all duration-300">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4 transform hover:rotate-12 transition-transform duration-300">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black text-orange-400 mb-2">GENRES</h3>
                            <p class="text-gray-400 text-sm">Choose your story type</p>
                        </div>
                        
                        <div class="space-y-4">
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="genre" value="fantasy" class="w-4 h-4 text-orange-500 bg-gray-600 border-gray-500 focus:ring-orange-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-purple-400">üßö</span>
                                    </div>
                                    <span class="text-white font-semibold">Fantasy</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="genre" value="adventure" class="w-4 h-4 text-orange-500 bg-gray-600 border-gray-500 focus:ring-orange-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-green-400">üèîÔ∏è</span>
                                    </div>
                                    <span class="text-white font-semibold">Adventure</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="genre" value="friendship" class="w-4 h-4 text-orange-500 bg-gray-600 border-gray-500 focus:ring-orange-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-yellow-400">ü§ù</span>
                                    </div>
                                    <span class="text-white font-semibold">Friendship</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Characters Column -->
                    <div class="bg-gray-800/30 rounded-3xl p-8 border border-gray-700 hover:border-teal-500/30 transition-all duration-300">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-teal-500 rounded-2xl flex items-center justify-center mx-auto mb-4 transform hover:rotate-12 transition-transform duration-300">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black text-teal-400 mb-2">MAIN CHARACTER</h3>
                            <p class="text-gray-400 text-sm">Who's the hero?</p>
                        </div>
                        
                        <div class="space-y-4">
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="character" value="princess" class="w-4 h-4 text-teal-500 bg-gray-600 border-gray-500 focus:ring-teal-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-pink-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-pink-400">üë∏</span>
                                    </div>
                                    <span class="text-white font-semibold">Princess</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="character" value="knight" class="w-4 h-4 text-teal-500 bg-gray-600 border-gray-500 focus:ring-teal-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-red-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-red-400">üõ°Ô∏è</span>
                                    </div>
                                    <span class="text-white font-semibold">Knight</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="character" value="wizard" class="w-4 h-4 text-teal-500 bg-gray-600 border-gray-500 focus:ring-teal-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-blue-400">üßô</span>
                                    </div>
                                    <span class="text-white font-semibold">Wizard</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="character" value="animal" class="w-4 h-4 text-teal-500 bg-gray-600 border-gray-500 focus:ring-teal-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-green-400">üêæ</span>
                                    </div>
                                    <span class="text-white font-semibold">Animal Friend</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Settings Column -->
                    <div class="bg-gray-800/30 rounded-3xl p-8 border border-gray-700 hover:border-purple-500/30 transition-all duration-300">
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-purple-500 rounded-2xl flex items-center justify-center mx-auto mb-4 transform hover:rotate-12 transition-transform duration-300">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
                                </svg>
                            </div>
                            <h3 class="text-2xl font-black text-purple-400 mb-2">SETTING</h3>
                            <p class="text-gray-400 text-sm">Where does it happen?</p>
                        </div>
                        
                        <div class="space-y-4">
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="setting" value="castle" class="w-4 h-4 text-purple-500 bg-gray-600 border-gray-500 focus:ring-purple-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-gray-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-gray-400">üè∞</span>
                                    </div>
                                    <span class="text-white font-semibold">Magic Castle</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="setting" value="forest" class="w-4 h-4 text-purple-500 bg-gray-600 border-gray-500 focus:ring-purple-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-green-400">üå≤</span>
                                    </div>
                                    <span class="text-white font-semibold">Enchanted Forest</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="setting" value="ocean" class="w-4 h-4 text-purple-500 bg-gray-600 border-gray-500 focus:ring-purple-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-blue-400">üåä</span>
                                    </div>
                                    <span class="text-white font-semibold">Magical Ocean</span>
                                </div>
                            </label>
                            
                            <label class="flex items-center gap-4 p-4 bg-gray-700/50 rounded-xl hover:bg-gray-700 transition-colors cursor-pointer">
                                <input type="radio" name="setting" value="space" class="w-4 h-4 text-purple-500 bg-gray-600 border-gray-500 focus:ring-purple-500" required>
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-indigo-500/20 rounded-lg flex items-center justify-center">
                                        <span class="text-indigo-400">üöÄ</span>
                                    </div>
                                    <span class="text-white font-semibold">Outer Space</span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Proceed Button with validation -->
                <div class="text-center">
                    <button type="submit" class="px-12 py-4 bg-button text-white font-bold text-lg rounded-2xl hover:scale-105 transform transition-all duration-300 shadow-xl">
                        ‚ú® NEXT STEP
                    </button>
                    <p class="text-gray-400 text-sm mt-3">Please select all three options above</p>
                </div>
            </div>
        </form>

        <!-- Step 2: Story Generation Form -->
        {% elif setstep2 %}
        <div>
            <div class="text-center mb-8">
                <div class="inline-flex items-center px-6 py-3 rounded-full bg-teal-500/10 border border-teal-500/20 mb-6">
                    <span class="text-teal-400 text-sm font-bold tracking-widest">üé® STEP 2 OF 2</span>
                </div>
                <h1 class="text-4xl lg:text-6xl font-black mb-4 leading-none">
                    <span class="text-white">Your Personalized</span><br>
                    <span class="text-gradient">AI Story</span>
                </h1>
                <p class="text-lg text-gray-300 max-w-2xl mx-auto">
                    Complete your story details and let the magic begin!
                </p>
            </div>

            <!-- ULTRA COMPACT Form Layout -->
            <form method="POST" action="{% url 'create_story' %}" id="storyForm" class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                {% csrf_token %}
                
                <!-- SUPER COMPACT Story Details Card -->
                <div class="compact-form rounded-2xl p-6 border border-gray-600/50 space-y-4">
                    <!-- Compact Header -->
                    <div class="text-center pb-3 border-b border-gray-600/30">
                        <div class="inline-flex items-center gap-2 mb-2">
                            <div class="w-8 h-8 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg flex items-center justify-center">
                                <span class="text-white text-sm">üé≠</span>
                            </div>
                            <h3 class="text-lg font-black text-pink-400">Story Details</h3>
                        </div>
                    </div>
                    
                    <!-- Hidden inputs from Step 1 -->
                    <input type="hidden" name="genre" value="{{ genre }}">
                    <input type="hidden" name="character" value="{{ character }}">
                    <input type="hidden" name="setting" value="{{ setting }}">
                    <input type="hidden" name="step2" value="step2">
                    
                    <!-- Ultra Compact Selections Display -->
                    <div class="form-section rounded-xl p-3">
                        <div class="grid grid-cols-3 gap-2 text-xs">
                            <div class="text-center">
                                <div class="text-orange-400 font-bold">{{ genre|title }}</div>
                                <div class="text-gray-500">Genre</div>
                            </div>
                            <div class="text-center">
                                <div class="text-teal-400 font-bold">{{ character|title }}</div>
                                <div class="text-gray-500">Hero</div>
                            </div>
                            <div class="text-center">
                                <div class="text-purple-400 font-bold">{{ setting|title }}</div>
                                <div class="text-gray-500">Setting</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Compact Input Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Child's Name -->
                        <div class="col-span-2">
                            <label class="block text-white font-semibold text-sm mb-2 flex items-center gap-2">
                                <span class="text-pink-400">üë§</span> Child's Name
                            </label>
                            <input type="text" name="child_name" id="childName" required 
                                   placeholder="Hero's name..." 
                                   class="form-input w-full px-3 py-2 rounded-lg text-white placeholder-gray-400 text-sm">
                        </div>
                        
                        <!-- Age Pills -->
                        <div class="col-span-2">
                            <label class="block text-white font-semibold text-sm mb-2 flex items-center gap-2">
                                <span class="text-teal-400">üéÇ</span> Age
                            </label>
                            <div class="flex gap-2">
                                <label class="age-radio-label flex-1 text-center py-2 bg-gray-700/50 rounded-lg cursor-pointer border border-gray-600 text-sm font-bold text-white hover:border-teal-500/50 transition-all" data-age="3-5">
                                    <input type="radio" name="child_age" value="3-5" class="sr-only" required>
                                    3-5
                                </label>
                                <label class="age-radio-label flex-1 text-center py-2 bg-gray-700/50 rounded-lg cursor-pointer border border-gray-600 text-sm font-bold text-white hover:border-teal-500/50 transition-all" data-age="5-7">
                                    <input type="radio" name="child_age" value="5-7" class="sr-only" required>
                                    5-7
                                </label>
                                <label class="age-radio-label flex-1 text-center py-2 bg-gray-700/50 rounded-lg cursor-pointer border border-gray-600 text-sm font-bold text-white hover:border-teal-500/50 transition-all" data-age="8-10">
                                    <input type="radio" name="child_age" value="8-10" class="sr-only" required>
                                    8-10
                                </label>
                            </div>
                        </div>
                        
                        <!-- Story Length -->
                        <div>
                            <label class="block text-white font-semibold text-sm mb-2 flex items-center gap-2">
                                <span class="text-purple-400">üìè</span> Length
                            </label>
                            <select name="story_length" class="form-input w-full px-3 py-2 rounded-lg text-white text-sm">
                                <option value="100">Short</option>
                                <option value="200" selected>Medium</option>
                                <option value="300">Long</option>
                            </select>
                        </div>
                        
                        <!-- Story Lesson -->
                        <div>
                            <label class="block text-white font-semibold text-sm mb-2 flex items-center gap-2">
                                <span class="text-green-400">üí°</span> Lesson
                            </label>
                            <select name="story_lesson" class="form-input w-full px-3 py-2 rounded-lg text-white text-sm">
                                <option value="">None</option>
                                <option value="kindness">Kindness</option>
                                <option value="courage">Courage</option>
                                <option value="honesty">Honesty</option>
                                <option value="sharing">Sharing</option>
                                <option value="friendship">Friendship</option>
                                <option value="responsibility">Responsibility</option>
                                <option value="perseverance">Perseverance</option>
                                <option value="empathy">Empathy</option>
                            </select>
                        </div>
                        
                        <!-- Special Request -->
                        <div class="col-span-2">
                            <label class="block text-white font-semibold text-sm mb-2 flex items-center gap-2">
                                <span class="text-yellow-400">‚≠ê</span> Special Request
                            </label>
                            <textarea name="special_request" rows="2" 
                                      placeholder="Any special elements? (pet, hobby, favorite color...)"
                                      class="form-input w-full px-3 py-2 rounded-lg text-white placeholder-gray-400 text-sm resize-none"></textarea>
                        </div>
                    </div>
                    
                    <!-- Compact Action Buttons -->
                    <div class="space-y-2 pt-3 border-t border-gray-600/30 flex-col justify-center">
                        <button type="submit" id="generateBtn" class="w-full px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold rounded-xl hover:from-pink-600 hover:to-purple-600 transform hover:scale-105 transition-all duration-300 text-sm flex items-center justify-center gap-2">
                            <span>ü™Ñ</span> GENERATE STORY
                        </button>
                        
                        <a href="{% url "create_story" %}" class="w-full px-4 py-2 bg-gray-700/80 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors text-sm flex justify-center ">
                            ‚Üê Back to Selection
                        </a>
                    </div>
                </div>

                <!-- Generated Story Display (Spans 2 columns) -->
                <div class="xl:col-span-2 bg-gray-800/30 rounded-2xl p-6 border border-gray-700">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-black text-green-400 flex items-center gap-3">
                            <div class="w-6 h-6 bg-green-500 rounded-lg flex items-center justify-center">
                                <span class="text-white text-xs">üìö</span>
                            </div>
                            Your AI-Generated Story
                        </h3>
                        
                        <!-- Story Controls -->
                        <div class="flex items-center gap-2">
                            <button id="readAloudBtn" onclick="toggleReadAloud()" class="px-3 py-2 bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 font-semibold rounded-lg hover:bg-cyan-500/30 transition-colors text-xs flex items-center gap-2 hidden">
                                <span>üîä</span> Read Aloud
                            </button>
                        </div>
                    </div>
                    
                    <!-- Story Content -->
                    <div id="story-content" class="bg-gray-700/50 rounded-xl p-6 min-h-[400px] border border-gray-600">
                        <!-- Default State - Ready to Generate -->
                        <div class="flex items-center justify-center h-full">
                            <div class="text-center">
                                <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse">
                                    <span class="text-white text-3xl">‚ú®</span>
                                </div>
                                <h4 class="text-2xl font-bold text-white mb-3">Ready to Create Magic?</h4>
                                <p class="text-gray-400 mb-6 max-w-md">Fill in your story details and click "Generate Story" to create a personalized bedtime tale!</p>
                                
                                <!-- Progress Indicators -->
                                <div class="flex items-center justify-center gap-4 text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                        <span class="text-green-400">Genre Selected</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-yellow-400 rounded-full animate-pulse"></div>
                                        <span class="text-yellow-400">Add Details</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 bg-gray-500 rounded-full"></div>
                                        <span class="text-gray-500">Generate Story</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Story Display (Only show if story exists) -->
        {% elif story %}
        <div>
            <div class="text-center mb-8">
                <div class="inline-flex items-center px-6 py-3 rounded-full bg-green-500/10 border border-green-500/20 mb-6">
                    <span class="text-green-400 text-sm font-bold tracking-widest">üéâ STORY COMPLETE</span>
                </div>
                <h1 class="text-4xl lg:text-6xl font-black mb-4 leading-none">
                    <span class="text-white">Your Magical</span><br>
                    <span class="text-gradient">Story is Ready!</span>
                </h1>
            </div>

            <!-- Story Display Card -->
            <div class="bg-gray-800/30 rounded-2xl p-8 border border-gray-700 max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-black text-green-400 flex items-center gap-3">
                        <div class="w-6 h-6 bg-green-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-xs">üìö</span>
                        </div>
                        Your Personalized Story
                    </h3>
                    
                    <!-- Story Controls -->
                    <div class="flex items-center gap-2">
                        <button id="readAloudBtn" onclick="toggleReadAloud()" class="px-3 py-2 bg-cyan-500/20 border border-cyan-500/30 text-cyan-400 font-semibold rounded-lg hover:bg-cyan-500/30 transition-colors text-xs flex items-center gap-2">
                            <span>üîä</span> Read Aloud
                        </button>
                    </div>
                </div>
                
                <!-- Story Content -->
                <div class="bg-gray-700/50 rounded-xl p-6 border border-gray-600">
                    <div class="story-text text-gray-200 leading-relaxed">
                        {% if title %}
                        <h2 class="text-3xl font-black text-center mb-6 text-gradient">{{ title }}</h2>
                        {% endif %}
                        
                        <div class="prose prose-lg prose-invert max-w-none">
                            <p class="whitespace-pre-line">{{ story }}</p>
                        </div>
                        
                        {% if moral %}
                        <div class="mt-6 p-4 bg-gradient-to-r from-green-500/10 to-teal-500/10 rounded-lg border border-green-500/30">
                            <p class="text-center text-green-400 font-bold text-sm">
                                üåü {{ moral }} üåü
                            </p>
                        </div>
                        {% endif %}
                        
                        <div class="mt-6 p-4 bg-gray-800/50 rounded-lg border border-purple-500/30">
                            <p class="text-center text-purple-400 font-bold text-sm">
                                ‚ú® Sweet dreams! Remember, you're the hero of your own amazing story! ‚ú®
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Story Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <form method="GET" action="{% url 'create_story' %}" class="inline">
                        <input type="hidden" name="saveStory" value="true">
                        <button type="submit" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-xl hover:from-green-600 hover:to-teal-600 transform hover:scale-105 transition-all duration-300 text-sm flex items-center justify-center gap-2">
                            <span>üíæ</span> Save Story
                        </button>
                    </form>
                    
                    <button onclick="shareStory()" class="px-4 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-xl hover:from-blue-600 hover:to-cyan-600 transform hover:scale-105 transition-all duration-300 text-sm flex items-center justify-center gap-2">
                        <span>üì§</span> Share Story
                    </button>
                    
                    <a href="{% url 'create_story' %}" class="px-4 py-3 bg-gradient-to-r from-orange-500 to-pink-500 text-white font-bold rounded-xl hover:from-orange-600 hover:to-pink-600 transform hover:scale-105 transition-all duration-300 text-sm flex items-center justify-center gap-2">
                        <span>‚ú®</span> New Story
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Show generating state (for JavaScript-based submission)
function showGeneratingState() {
    const contentElement = document.getElementById('story-content');
    const generateBtn = document.getElementById('generateBtn');
    
    // Update button state
    if (generateBtn) {
        generateBtn.disabled = true;
        generateBtn.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                <span>GENERATING...</span>
            </div>
        `;
    }
    
    // Show loading content
    if (contentElement) {
        contentElement.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <div class="flex items-center justify-center gap-2 mb-6">
                        <div class="w-4 h-4 bg-purple-400 rounded-full animate-bounce"></div>
                        <div class="w-4 h-4 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        <div class="w-4 h-4 bg-orange-400 rounded-full animate-bounce" style="animation-delay: 0.4s;"></div>
                    </div>
                    <h4 class="text-2xl font-bold text-purple-400 mb-3">AI Creating Your Story...</h4>
                    <p class="text-gray-400 mb-6">Crafting a magical tale just for you...</p>
                    
                    <div class="w-64 bg-gray-600 rounded-full h-3 mx-auto mb-2">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full animate-pulse" style="width: 65%"></div>
                    </div>
                    <p class="text-xs text-gray-500">This usually takes 10-30 seconds...</p>
                </div>
            </div>
        `;
    }
}

// Hide generating state (reset form)
function hideGeneratingState() {
    const generateBtn = document.getElementById('generateBtn');
    
    if (generateBtn) {
        // Reset button state
        generateBtn.disabled = false;
        generateBtn.innerHTML = `
            <span>ü™Ñ</span>
            <span>GENERATE STORY</span>
        `;
    }
}

// Toggle read aloud functionality
function toggleReadAloud() {
    const btn = document.getElementById('readAloudBtn');
    const storyText = document.querySelector('.story-text');
    
    if (!btn || !storyText) return;
    
    if (btn.textContent.includes('Read Aloud')) {
        // Start reading
        btn.innerHTML = '<span>‚è∏Ô∏è</span> Stop Reading';
        btn.classList.remove('bg-cyan-500/20', 'border-cyan-500/30', 'text-cyan-400');
        btn.classList.add('bg-red-500/20', 'border-red-500/30', 'text-red-400');
        
        // Web Speech API integration
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(storyText.textContent);
            utterance.rate = 0.8;
            utterance.pitch = 1.1;
            utterance.onend = function() {
                // Reset button when speech ends
                btn.innerHTML = '<span>üîä</span> Read Aloud';
                btn.classList.remove('bg-red-500/20', 'border-red-500/30', 'text-red-400');
                btn.classList.add('bg-cyan-500/20', 'border-cyan-500/30', 'text-cyan-400');
            };
            speechSynthesis.speak(utterance);
        }
    } else {
        // Stop reading
        btn.innerHTML = '<span>üîä</span> Read Aloud';
        btn.classList.remove('bg-red-500/20', 'border-red-500/30', 'text-red-400');
        btn.classList.add('bg-cyan-500/20', 'border-cyan-500/30', 'text-cyan-400');
        
        if ('speechSynthesis' in window) {
            speechSynthesis.cancel();
        }
    }
}

// Share story functionality
function shareStory() {
    if (navigator.share) {
        navigator.share({
            title: 'My AI-Generated Bedtime Story',
            text: 'Check out this amazing personalized story created with StorySpark!',
            url: window.location.href
        });
    } else {
        // Fallback - copy to clipboard
        navigator.clipboard.writeText(window.location.href).then(() => {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = 'üì§ Story link copied to clipboard!';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        });
    }
}

// Enhanced form handling and validation
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced radio button interactions for Step 1
    const step1RadioButtons = document.querySelectorAll('#step1 input[type="radio"]');
    step1RadioButtons.forEach(radio => {
        radio.addEventListener('change', function() {
            // Add visual feedback when selections are made
            const label = this.closest('label');
            label.classList.add('ring-2', 'ring-offset-2', 'ring-offset-gray-800');
            
            // Remove ring from other options in the same group
            document.querySelectorAll(`#step1 input[name="${this.name}"]`).forEach(other => {
                if (other !== this) {
                    other.closest('label').classList.remove('ring-2', 'ring-offset-2', 'ring-offset-gray-800');
                }
            });
        });
    });
    
    // Enhanced radio button interactions for Step 2 age selection
    const ageRadioLabels = document.querySelectorAll('.age-radio-label');
    ageRadioLabels.forEach(label => {
        label.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Remove selected state from all age buttons
            ageRadioLabels.forEach(lbl => {
                lbl.classList.remove('selected');
                const radio = lbl.querySelector('input[type="radio"]');
                if (radio) radio.checked = false;
            });
            
            // Add selected state to clicked button
            this.classList.add('selected');
            const radio = this.querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        });
    });
    
    // Form submission handling
    const storyForm = document.getElementById('storyForm');
    if (storyForm) {
        storyForm.addEventListener('submit', function(e) {
            // Client-side validation
            const childName = document.querySelector('input[name="child_name"]');
            const childAge = document.querySelector('input[name="child_age"]:checked');
            
            if (childName && !childName.value.trim()) {
                e.preventDefault();
                alert('Please enter the child\'s name!');
                childName.focus();
                return false;
            }
            
            if (!childAge) {
                e.preventDefault();
                alert('Please select the child\'s age!');
                return false;
            }
            
            // Show generating state on form submission
            showGeneratingState();
        });
    }
    
    // Show read aloud button if story exists
    if (document.querySelector('.story-text')) {
        const readAloudBtn = document.getElementById('readAloudBtn');
        if (readAloudBtn) {
            readAloudBtn.classList.remove('hidden');
        }
    }
});
</script>

{% endblock %}